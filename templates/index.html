<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Evaluation</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .container {
            margin-top: 50px;
        }
        .tags {
            display: flex;
            flex-wrap: wrap;
        }
        .tag {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center">Resume Evaluation</h2>
        <form id="resume-form">
            <div class="form-group">
                <label for="resume_file">Upload Resume (PDF or DOCX):</label>
                <input type="file" class="form-control-file" id="resume_file" name="resume_file" accept=".pdf,.docx" required>
            </div>
            <div class="form-group">
                <label for="job_description">Job Description:</label>
                <textarea class="form-control" id="job_description" name="job_description" rows="5" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Evaluate</button>
        </form>

        <div id="result" style="margin-top: 30px; display: none;">
            <h3>Evaluation Results</h3>
            <div class="row">
                <div class="col-md-4">
                    <canvas id="matchChart"></canvas>
                    <p id="matchText"></p>
                </div>
                <div class="col-md-4">
                    <h4>Matching Skills</h4>
                    <div class="tags" id="matchingTags"></div>
                    <h4>Non-Matching Skills</h4>
                    <div class="tags" id="nonMatchingTags"></div>
                </div>
                <div class="col-md-4">
                    <h4>Job Analysis</h4>
                    <p><strong>Language Tone:</strong> <span id="languageTone"></span></p>
                    <p><strong>Emphasis:</strong> <span id="emphasis"></span></p>
                    <p><strong>Social Responsibility:</strong> <span id="socialResponsibility"></span></p>
                    <h5>Keyword Density</h5>
                    <ul id="keywordDensity"></ul>
                </div>
            </div>
            <button id="optimizeResumeButton" class="btn btn-success">Generate Updated Resume</button>
        </div>
    </div>

    <script>
        document.getElementById('resume-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData();
            formData.append('resume_file', document.getElementById('resume_file').files[0]);
            formData.append('job_description', document.getElementById('job_description').value);

            const response = await fetch('/evaluate', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                document.getElementById('result').style.display = 'block';

                const matchScore = result.match_score;
                const matchChart = new Chart(document.getElementById('matchChart').getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['Match', 'Mismatch'],
                        datasets: [{
                            data: [matchScore, 100 - matchScore],
                            backgroundColor: ['#4caf50', '#f44336']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                        return tooltipItem.raw.toFixed(2) + '%';
                                    }
                                }
                            }
                        }
                    }
                });

                document.getElementById('matchText').innerText = matchScore >= 90 ? 'Strong Match' : matchScore >= 70 ? 'Good Match' : 'Weak Match';

                const matchingTags = document.getElementById('matchingTags');
                matchingTags.innerHTML = '';
                result.relevant_tags.forEach(tag => {
                    const span = document.createElement('span');
                    span.className = 'tag';
                    span.innerText = tag;
                    matchingTags.appendChild(span);
                });

                const nonMatchingTags = document.getElementById('nonMatchingTags');
                nonMatchingTags.innerHTML = '';
                result.non_matching_tags.forEach(tag => {
                    const span = document.createElement('span');
                    span.className = 'tag';
                    span.innerText = tag;
                    nonMatchingTags.appendChild(span);
                });

                document.getElementById('languageTone').innerText = result.job_analysis.language_tone;
                document.getElementById('emphasis').innerText = result.job_analysis.emphasis_teamwork;
                document.getElementById('socialResponsibility').innerText = result.job_analysis.social_responsibility ? 'Yes' : 'No';

                const keywordDensity = document.getElementById('keywordDensity');
                keywordDensity.innerHTML = '';
                result.job_analysis.keyword_density.forEach(keyword => {
                    const li = document.createElement('li');
                    li.innerText = `${keyword[0]} (${keyword[1]})`;
                    keywordDensity.appendChild(li);
                });
            } else {
                alert(result.error);
            }
        });

        document.getElementById('optimizeResumeButton').addEventListener('click', async function () {
            const response = await fetch('/get-non-matching-tags');
            const result = await response.json();

            if (response.ok) {
                const selectedTags = result.non_matching_tags;
                const response = await fetch('/generate-resume', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tags: selectedTags })
                });

                const result = await response.json();

                if (response.ok) {
                    window.location.href = result.download_link;
                } else {
                    alert(result.error);
                }
            } else {
                alert(result.error);
            }
        });
    </script>
</body>
</html>
